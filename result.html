<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quiz Results â€“ Charts (with Google Sheets CSV)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .controls { margin-bottom: 20px; }
    input[type="url"], button { padding: 8px; font-size: 16px; }
    input[type="url"] { width: 60%; }
    canvas { max-width: 100%; margin: 20px 0; }
  </style>
</head>
<body>
  <h1>Quiz Results Charts</h1>
  <div class="controls">
    <input type="url" id="sheetUrl" placeholder="Paste Google Sheets CSV URL here"/>
    <button id="loadSheetBtn">Load Sheet</button>
  </div>
  <canvas id="avgByClass"></canvas>

  <script>
    // Utility functions
    function detectDelimiter(text) {
      if (text.includes('\t')) return '\t';
      if (text.includes(',')) return ',';
      return /\s{2,}/;
    }
    function csvToArray(text) {
      const delim = detectDelimiter(text);
      return text.trim().split(/\r?\n/).map(line => line.split(delim).map(s => s.trim()));
    }

    function coerceNum(v) {
      const n = Number(String(v).replace(/[^0-9.-]/g, ''));
      return Number.isFinite(n) ? n : null;
    }

    function aggregateAvgByClass(list) {
      const map = new Map();
      list.forEach(r => {
        if (!map.has(r.class)) map.set(r.class, { sum: 0, count: 0 });
        const m = map.get(r.class);
        m.sum += r.score;
        m.count += 1;
      });
      return Array.from(map.entries())
        .map(([cls, { sum, count }]) => ({ cls, avg: sum / count }))
        .sort((a, b) => a.cls - b.cls);
    }

    function filterClassesAndRemoveTop(list, classesToKeep, topToRemove) {
      let filtered = list.filter(r => classesToKeep.includes(r.class));
      filtered = filtered.sort((a, b) => b.score - a.score).slice(topToRemove);
      return filtered;
    }

    function renderChart(data) {
      const ctx = document.getElementById('avgByClass').getContext('2d');
      if (window.avgChart) window.avgChart.destroy();
      window.avgChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => `Class ${d.cls}`),
          datasets: [{ label: 'Average Score (excl. top 10)', data: data.map(d => d.avg.toFixed(2)) }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true, max: 30 } }
        }
      });
    }

    // Main sheet loader
    document.getElementById('loadSheetBtn').addEventListener('click', () => {
      const url = document.getElementById('sheetUrl').value.trim();
      if (!url) return alert('Please paste the published CSV URL.');

      fetch(url)
        .then(r => r.text())
        .then(csv => {
          const rows = csvToArray(csv);
          const [h, ...body] = rows;
          const H = h.map(s => s.toLowerCase());
          const idxName = H.findIndex(s => s.includes('name'));
          const idxClass = H.findIndex(s => s.includes('class'));
          const idxScore = H.findIndex(s => s.includes('score'));
          if (idxName < 0 || idxClass < 0 || idxScore < 0) {
            return alert('CSV must contain Name, Class, and Score columns.');
          }

          const data = body.map(r => ({
            name: r[idxName],
            class: coerceNum(r[idxClass]),
            score: coerceNum(r[idxScore]),
          })).filter(r => r.class !== null && r.score !== null);

          const classesToKeep = [6, 7, 8, 9, 10, 11];
          const filtered = filterClassesAndRemoveTop(data, classesToKeep, 10);
          const chartData = aggregateAvgByClass(filtered);
          renderChart(chartData);
        })
        .catch(err => alert('Error loading CSV: ' + err));
    });
  </script>
</body>
</html>

