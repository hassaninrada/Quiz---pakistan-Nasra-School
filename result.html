<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quiz Results - Live</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
  .container {
    background: white; padding: 20px; border-radius: 10px;
    box-shadow: 0 0 10px #ccc; max-width: 900px; margin: auto;
  }
  h1 { text-align: center; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
  select, button { padding: 8px; margin: 5px 0; }
  canvas { margin-top: 20px; }
</style>
</head>
<body>

<div class="container">
  <h1>Live Quiz Results</h1>

  <label for="classFilter">Filter by Class:</label>
  <select id="classFilter" onchange="filterResults()">
    <option value="all">All</option>
  </select>

  <canvas id="barChart" width="400" height="200"></canvas>
  <div id="resultsTable"></div>
</div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRzmf9_t1P1kLDWEfa4UGnC1ikU5QuZytWk6zfBxHsOfhYE3JPbzLFaVG4FVP_W9mXp4duQC0sdIGsf/pub?output=csv";
const ctx = document.getElementById("barChart").getContext("2d");
let chart;
let allResults = [];

async function loadResults() {
  const res = await fetch(SHEET_URL);
  const text = await res.text();
  const rows = text.trim().split("\n").map(r => r.split(","));

  // Assuming first row is header: Name,Class,Score,Total,Time
  allResults = rows.slice(1).map(row => ({
    name: row[0],
    class: row[1],
    score: Number(row[2]),
    total: Number(row[3]),
    time: row[4]
  }));

  populateClassFilter();
  filterResults();
}

function populateClassFilter() {
  const classes = [...new Set(allResults.map(r => r.class))];
  const select = document.getElementById("classFilter");
  select.innerHTML = `<option value="all">All</option>` +
                     classes.map(c => `<option value="${c}">${c}</option>`).join("");
}

function filterResults() {
  const filter = document.getElementById("classFilter").value;
  const filtered = filter === "all" ? allResults : allResults.filter(r => r.class === filter);
  renderChart(filtered);
  renderTable(filtered);
}

function renderChart(results) {
  const labels = results.map(r => r.name);
  const scores = results.map(r => r.score);

  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "Score (out of 30)",
        data: scores,
        backgroundColor: "rgba(75, 192, 192, 0.6)"
      }]
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              let original = results[context.dataIndex];
              return `${original.score}/${original.total}`;
            }
          }
        }
      },
      scales: {
        y: { beginAtZero: true, max: 30, ticks: { stepSize: 1 } }
      }
    }
  });
}

function renderTable(results) {
  let tableHTML = `<table>
    <tr><th>Name</th><th>Class</th><th>Score</th><th>Total</th><th>Time</th></tr>`;
  results.forEach(r => {
    tableHTML += `<tr>
      <td>${r.name}</td>
      <td>${r.class}</td>
      <td>${r.score}</td>
      <td>${r.total}</td>
      <td>${r.time}</td>
    </tr>`;
  });
  tableHTML += `</table>`;
  document.getElementById("resultsTable").innerHTML = tableHTML;
}

// Load data on page load
loadResults();
  const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRzmf9_t1P1kLDWEfa4UGnC1ikU5QuZytWk6zfBxHsOfhYE3JPbzLFaVG4FVP_W9mXp4duQC0sdIGsf/pub?output=csv";
const PROXY_URL = "https://api.allorigins.win/raw?url=" + encodeURIComponent(SHEET_URL);

async function loadResults() {
  const res = await fetch(PROXY_URL);
  const text = await res.text();
  // rest of your CSV parsing code here...
}

</script>

</body>
</html>
